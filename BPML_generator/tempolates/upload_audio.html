<!DOCTYPE html>
<html>
<head>
    <title>Запись голоса с отправкой на сервер</title>
    <!-- Подключаем библиотеку lamejs для кодирования в MP3 -->
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
</head>
<body>
    <h1>Запись голоса</h1>
    <button id="startRecord">Начать запись</button>
    <button id="stopRecord" disabled>Остановить запись</button>
    <audio id="audioPlayer" controls></audio>
    <a id="downloadLink" style="display: none;">Скачать запись</a>
    <div id="status"></div>

    <script>
        const startBtn = document.getElementById('startRecord');
        const stopBtn = document.getElementById('stopRecord');
        const audioPlayer = document.getElementById('audioPlayer');
        const downloadLink = document.getElementById('downloadLink');
        const statusDiv = document.getElementById('status');

        let mediaRecorder;
        let audioChunks = [];
        let audioContext;
        let microphone;

        // Функция для кодирования WAV в MP3
        function encodeToMp3(audioBuffer) {
            const channels = audioBuffer.numberOfChannels;
            const sampleRate = audioBuffer.sampleRate;
            const samples = audioBuffer.getChannelData(0);

            const mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, 128);
            const sampleBlockSize = 1152;
            const mp3Data = [];

            for (let i = 0; i < samples.length; i += sampleBlockSize) {
                const sampleChunk = samples.subarray(i, i + sampleBlockSize);
                const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
                if (mp3buf.length > 0) {
                    mp3Data.push(mp3buf);
                }
            }

            const mp3buf = mp3encoder.flush();
            if (mp3buf.length > 0) {
                mp3Data.push(mp3buf);
            }

            return new Blob(mp3Data, { type: 'audio/mp3' });
        }

        // Функция для отправки файла на сервер
        async function sendToServer(blob) {
            statusDiv.textContent = "Отправка на сервер...";

            const formData = new FormData();
            formData.append('audio', blob, 'recording.mp3');

            try {
                const response = await fetch('https://your-server.com/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                statusDiv.textContent = "Файл успешно отправлен!";
                console.log("Ответ сервера:", result);
            } catch (error) {
                statusDiv.textContent = "Ошибка отправки: " + error.message;
                console.error("Ошибка:", error);
            }
        }

        // Запрос разрешения на микрофон и начало записи
        startBtn.addEventListener('click', async () => {
            try {
                statusDiv.textContent = "Запись начата...";

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                microphone = audioContext.createMediaStreamSource(stream);

                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });

                    // Конвертируем WAV в MP3
                    const arrayBuffer = await audioBlob.arrayBuffer();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    const mp3Blob = encodeToMp3(audioBuffer);

                    const audioUrl = URL.createObjectURL(mp3Blob);
                    audioPlayer.src = audioUrl;

                    // Создание ссылки для скачивания
                    downloadLink.href = audioUrl;
                    downloadLink.download = 'recording.mp3';
                    downloadLink.style.display = 'block';

                    // Отправка на сервер
                    await sendToServer(mp3Blob);
                };

                mediaRecorder.start();
                startBtn.disabled = true;
                stopBtn.disabled = false;
                audioChunks = [];
            } catch (error) {
                statusDiv.textContent = "Ошибка: " + error.message;
                console.error('Ошибка доступа к микрофону:', error);
            }
        });

        // Остановка записи
        stopBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                if (microphone) microphone.disconnect();
                startBtn.disabled = false;
                stopBtn.disabled = true;
                statusDiv.textContent = "Запись остановлена";
            }
        });
    </script>
</body>
</html>